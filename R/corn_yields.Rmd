---
title: "Corn Yield Analysis"
author: "Rodney Murray"
date: "3/19/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, warning=FALSE, message=F}
library(dplyr)
library(tidyr)
library(ggplot2)
library(readr)
library(stringr)
library(nlme)
library(car)
library(forecast)
library(ggpubr)
```

## Data Loading
Here we will load the data and filter such that we are looking for entries related to irrigated (or non-irrigated) grain corn.
```{r}
corn <- read.csv('../data/more_corn.csv')
corn <- corn %>%
  filter(grepl('IRRIGATED', Data.Item)) %>% 
  filter(grepl('GRAIN', Data.Item))
corn
```

Next we do some reprocessing such as separating out the description to get the data we need on if it was irrigated or not, and what the measure was. Then we pivot the data so it is easier to do some calculations with the area and produciton volumes.
```{r}
process_data <- function(corn) {
  corn <- corn %>% 
    separate(Data.Item, sep=',', into=c('Crop', 'Type', 'Measure')) %>% 
    separate(Measure, sep=' - ', into=c('Irrigated', 'Variable')) %>% 
    arrange(Year, State) %>%
    mutate(
      State = as.factor(State),
      County = as.factor(County),
      Type = as.factor(Type),
      Irrigated = str_replace_all(Irrigated, ' ', ''),
      Irrigated = as.factor(Irrigated),
      Variable = factor(str_replace_all(Variable, ' ', '.')),
      Value = as.numeric(str_replace_all(Value, ',', ''))
      ) %>% 
    pivot_wider(
      id_cols = c(Year, State, Ag.District, Ag.District.Code, County, Commodity, Type, Irrigated),
      names_from = Variable,
      values_from = Value
    ) %>% 
    mutate(YIELD = PRODUCTION / ACRES.HARVESTED)
  return(corn)
}
corn <- process_data(corn)
corn
```

Check for NA's and the size of the resulting dataset
```{r}
colSums(is.na(corn))
nrow(corn)
```

Next we will plot the production and yield. 
```{r}
fig <- ggplot(corn, aes(x=Year,y=PRODUCTION, color=State)) +
  facet_grid(rows=vars(Irrigated), cols=vars(Type)) +
  geom_line()
fig

fig <- ggplot(corn, aes(x=Year,y=YIELD, color=State)) +
  facet_grid(rows=vars(Irrigated), cols=vars(Type)) +
  geom_line()
fig
```
From the two plots above it is amazing to see how the grain production and yields have improved over time! I'm interested in grouping some states which I think more alike (places like Wyoming, Montana and Idaho vs. Nebraska and Kansas).


## Data Aggregation

```{r}
# Define the groups
areas = list(
  'COLORADO'='MTN_WEST', 
  'WYOMING'='MTN_WEST', 
  'IDAHO'='MTN_WEST', 
  'MONTANA'='MTN_WEST', 
  'NEW MEXICO'='SOUTH', 
  'DELAWARE'='EAST', 
  'TEXAS'='SOUTH', 
  'NEBRASKA'='MID_WEST', 
  'OKLAHOMA'='SOUTH', 
  'SOUTH DAKOTA'='MID_WEST', 
  'NORTH DAKOTA'='MID_WEST', 
  'KANSAS'='MID_WEST'
  )
corn <- mutate(corn, area=recode_factor(corn$State, !!!areas))

# Aggregate the production, area, and yiels by the groups
area_corn <- corn %>% 
  group_by(Year, area, Commodity, Type, Irrigated) %>% 
  summarize(
    PRODUCTION=sum(PRODUCTION),
    ACRES.HARVESTED=sum(ACRES.HARVESTED),
    .groups='keep'
    ) %>% 
  ungroup() %>% 
  mutate(YIELD = PRODUCTION / ACRES.HARVESTED)

# Make a similar plot as above with the groups
fig <- ggplot(area_corn, aes(x=Year,y=YIELD, color=area)) +
  facet_grid(rows=vars(Irrigated), cols=vars(Type)) +
  geom_line()
fig
```
This will provide simpler data to work with, but still maintain variance between groups. It's interesting to note that for the irrigated acres prior to 1980 there appeared to be some difference between the areas, and afterwards there is no perceivable difference. This is not the same for the non-irrigated areas though! 

## Area Modeling
I will proceed to fit a model for the different areas as well as if the crops were irrigated or not.
```{r}
area_lm <- lm(YIELD ~ area + Irrigated + Year, data=area_corn)
summary(area_lm)
plot(area_lm)

ggplot() + geom_point(aes(x=area_corn$YIELD, y=area_lm$fitted.values), alpha=0.6) +
  geom_abline(color='red')
```
Looks like the model does a reasonable job of predicting the yield, however the residual plots show that there certainly is room for improvement. We have some trends in the mean of the residuals vs. the predicted values and the QQ plot shows that they are not normally distributed around the mean. There may also be some issues with the assumption around constant variance, and if we look closely at the plots above showing the production and yields over time we may suspect that the residuals are correlated and not indpendent. Looks like we're breaking a lot of our assumptions. Lets see if we can get in a little better position by allowing the categorical variables to have a multiplicative influence instead (so they can change the slope of the line) instead of having only an additive influence which allows them to only change the intercept.

We can easily add the multiplicative influence by asking R to fit a model with all of the interactions as shown below.
```{r}
area_lm <- lm(YIELD ~ (area + Irrigated + Year)^2, data=area_corn)
summary(area_lm)
plot(area_lm)
ggplot() + geom_point(aes(x=area_corn$YIELD, y=area_lm$fitted.values), alpha=0.6) +
  geom_abline(color='red')
ggplot() + geom_density(aes(x=area_lm$residuals))
```
Things area starting to look a little bit better, we don't have quite as bad of a trend in the mean of our residuals and our QQ-plot while not great is looking like we're getting a little closer to normally distributed. With that said we should look into the potential for autocorrelation for our groups.

We will look at the autocorrelation by grouping our data then using the `acf()` function to look for correlation over time.
```{r}
areas <- c('MTN_WEST', 'MID_WEST')
irrigated <- c('IRRIGATED', 'NON-IRRIGATED')
figs <- 1:4
count <- 1
fig_list <- list()
for (plot_area in areas) {
  for (irrigate in irrigated) {
    is_area <- area_corn$area == plot_area
    is_irrigate <- area_corn$Irrigated == irrigate
    print(irrigate)
    print(sum(is_area))
    print(sum(is_irrigate))
    residuals <- area_lm$residuals[is_area & is_irrigate]
    if (length(residuals) > 1) {
      fig <- ggAcf(residuals) + labs(title=paste(plot_area, ' ', irrigate))
      show(fig)
      figs[count] <- c(fig)
    }
    count <- count + 1
  }
}
```

As suspected, it looks like we do have some pretty serious autocorrelations to deal with. I will attempt
to do this through the use of Generalized Least Squares (GLS).

## GLS
```{r}
area_corn <- area_corn %>% 
  mutate(area_irrigate = paste(as.character(area), as.character(Irrigated), sep='_'))

formula <- YIELD ~ Year + area_irrigate + Year:area_irrigate

gls_area_mult <- gls(formula,
                correlation = corAR1(form=~Year | area_irrigate), # Auto-Regressive order 1
                data = area_corn,
                method='ML' # Maximum Likelihood
                )
gls_area_mult
AIC(gls_area_mult)
summary(gls_area_mult)
ggplot() + geom_point(aes(x=area_corn$YIELD, y=gls_area_mult$fitted))
plot(gls_area_mult)
```



